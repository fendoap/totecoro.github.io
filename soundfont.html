<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>MIDI × SoundFont プレイヤー</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 20px;
    }
    #status {
      margin-top: 15px;
      font-weight: bold;
    }
    small {
      display: block;
      margin-top: 10px;
      color: #555;
    }
    button {
      padding: 10px 15px;
      font-size: 16px;
      cursor: pointer;
    }
    input[type="file"] {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>MIDI × SoundFont プレイヤー</h1>

  <input type="file" id="midiInput" accept=".mid,.midi"><br>
  <button id="playBtn" disabled>再生</button>

  <div id="status">SoundFontをロード中...</div>
  <small>※ sf2ファイルのロードには数秒かかることがあります。</small>

  <script src="https://cdn.jsdelivr.net/npm/@g200kg/fluidsynth@2.3.4/dist/fluidsynth.js"></script>

  <script>
    let synth = null;
    let player = null;
    let midiFileBuffer = null;

    const midiInput = document.getElementById('midiInput');
    const playBtn = document.getElementById('playBtn');
    const statusDiv = document.getElementById('status');

    // --- SoundFontファイルの指定 ---
    // HTMLファイルと同じフォルダに "mini_piano.sf2" を置いている場合
    const sf2url = "mini_piano.sf2";
    // もしファイル名が違う場合や、別の場所にある場合は、ここを適切に変更してください。
    // 例: "soundfonts/my_soundfont.sf2"

    // FluidSynth.js の準備が完了したら実行
    if (typeof fluidsynth !== 'undefined') {
      fluidsynth.ready.then(function () {
        statusDiv.textContent = "FluidSynth準備完了。SoundFontをロード中...";
        synth = new fluidsynth.Synth();

        // SoundFontファイルをフェッチしてロード
        fetch(sf2url)
          .then(response => {
            if (!response.ok) {
              throw new Error(`SoundFontファイルの取得に失敗: ${response.status} ${response.statusText}`);
            }
            return response.arrayBuffer();
          })
          .then(arrayBuffer => {
            const result = synth.sfloadMem(arrayBuffer, true); // true = set as default
            if (result === -1) {
              throw new Error("SoundFontのシンセサイザーへのロードに失敗しました。");
            }
            statusDiv.textContent = "SoundFontロード完了。MIDIファイルを選択してください。";
            // MIDIファイル入力欄を有効化 (任意、初期状態は有効)
            // midiInput.disabled = false;
          })
          .catch(error => {
            console.error("SoundFontロードエラー:", error);
            statusDiv.textContent = `SoundFont (${sf2url}) のロードに失敗しました: ${error.message}`;
            playBtn.disabled = true; // SoundFontがないと再生できないのでボタンを無効化
          });
      }).catch(error => {
          console.error("FluidSynth.ready でエラー:", error);
          statusDiv.textContent = "FluidSynthライブラリの初期化に失敗しました。ページを再読み込みしてみてください。";
      });
    } else {
      // このメッセージが表示される場合、fluidsynth.jsの読み込み自体に失敗しています。
      // (CDNのリンク切れ、ネットワークの問題、ブラウザの拡張機能によるブロックなど)
      statusDiv.textContent = "FluidSynthライブラリの読み込みに失敗しました。ネットワーク接続とブラウザのコンソールを確認してください。";
      console.error("fluidsynthオブジェクトが定義されていません。");
      playBtn.disabled = true;
    }

    // MIDIファイルが選択されたときの処理
    midiInput.addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) {
        playBtn.disabled = true;
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        midiFileBuffer = new Uint8Array(e.target.result);
        statusDiv.textContent = `MIDIファイル「${file.name}」準備完了。再生ボタンを押してください。`;
        if (synth && synth.isReady && synth.isReady()) { // synth がロード済みか確認 (isReadyは存在すれば)
             playBtn.disabled = false;
        } else if (synth) { // isReadyがなくてもsynthがあれば一旦有効化
             playBtn.disabled = false;
        } else {
             statusDiv.textContent += " (ただしSoundFont未ロード)";
             playBtn.disabled = true;
        }
      };
      reader.onerror = function(e) {
        console.error("MIDIファイル読み込みエラー:", e);
        statusDiv.textContent = "MIDIファイルの読み込みに失敗しました。";
        midiFileBuffer = null;
        playBtn.disabled = true;
      };
      reader.readAsArrayBuffer(file);
    });

    // 再生ボタンがクリックされたときの処理
    playBtn.addEventListener('click', function() {
      if (!synth || !midiFileBuffer) {
        statusDiv.textContent = "再生の準備ができていません。SoundFontとMIDIファイルを確認してください。";
        return;
      }

      // 既存のプレイヤーがあれば停止
      if (player) {
        player.stop();
      }

      player = new fluidsynth.Player(synth);

      player.playMem(midiFileBuffer);
      statusDiv.textContent = "再生中...";

      player.on('endOfScore', function() {
        statusDiv.textContent = "再生終了。";
        // 必要であれば、ここで再生ボタンを再度無効化するなど
        // playBtn.disabled = true;
      });

      // (オプション) プレイヤーエラーハンドリング
      // player.on('error', function(err) {
      //   console.error("再生エラー:", err);
      //   statusDiv.textContent = "再生中にエラーが発生しました。";
      // });
    });

  </script>
</body>
</html>
